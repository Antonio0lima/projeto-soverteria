<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificações</title>
    <link rel="stylesheet" href="/css/notificacoes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

 <% if (usuario && usuario.tipo==="admin" ) { %>
        <%- include("partials/navbar/navbar-adm") %>
            <% } else { %>
                <%- include("partials/navbar/navbar") %>
                    <% } %>

    <div class="notificacoes-container">
        <div class="notificacoes-header">
            <h1><i class="fas fa-bell"></i> Notificações</h1>
            <div class="header-actions">
                <button class="btn-marcar-todas" onclick="marcarTodasComoLidas()">
                    <i class="fas fa-check-double"></i> Marcar todas como lidas
                </button>
                <a href="/inicial" class="btn-voltar">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>

        <div class="notificacoes-stats">
            <div class="stat-card">
                <div class="stat-number"><%= notificacoes.filter(n => !n.lida).length %></div>
                <div class="stat-label">Não lidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><%= notificacoes.length %></div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div class="notificacoes-list">
            <% if (notificacoes.length === 0) { %>
                <div class="notificacao-vazia">
                    <i class="fas fa-bell-slash"></i>
                    <h3>Nenhuma notificação</h3>
                    <p>Quando houver atualizações nos seus pedidos, elas aparecerão aqui.</p>
                </div>
            <% } else { %>
                <% notificacoes.forEach(not => { %>
                    <div class="notificacao-item <%= not.lida ? 'lida' : 'nao-lida' %>" 
                         onclick="marcarComoLida(<%= not.id %>, this)">
                        <div class="notificacao-icon">
                            <% if (not.tipo === 'status_pedido') { %>
                                <i class="fas fa-shopping-bag"></i>
                            <% } else { %>
                                <i class="fas fa-info-circle"></i>
                            <% } %>
                        </div>
                        <div class="notificacao-content">
                            <div class="notificacao-titulo">
                                <%= not.titulo %>
                                <% if (!not.lida) { %>
                                    <span class="badge-nova">NOVA</span>
                                <% } %>
                            </div>
                            <div class="notificacao-mensagem"><%= not.mensagem %></div>
                            <div class="notificacao-data">
                                <i class="fas fa-clock"></i> <%= not.data_formatada %>
                                <% if (not.pedido_id) { %>
                                    <span class="pedido-id">Pedido #<%= not.pedido_id %></span>
                                <% } %>
                            </div>
                        </div>
                        <div class="notificacao-actions">
                            <% if (!not.lida) { %>
                                <button class="btn-marcar-lida" onclick="event.stopPropagation(); marcarComoLida(<%= not.id %>, this.parentElement.parentElement)">
                                    <i class="fas fa-check"></i>
                                </button>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <script>
        async function marcarComoLida(notificacao_id, elemento) {
            try {
                const response = await fetch('/notificacao/marcar-lida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificacao_id })
                });

                const data = await response.json();
                
                if (data.sucesso && elemento) {
                    // Atualizar visualmente
                    elemento.classList.remove('nao-lida');
                    elemento.classList.add('lida');
                    
                    // Remover badge "NOVA"
                    const badge = elemento.querySelector('.badge-nova');
                    if (badge) badge.remove();
                    
                    // Remover botão de marcar como lida
                    const btn = elemento.querySelector('.btn-marcar-lida');
                    if (btn) btn.remove();
                    
                    // Atualizar contador
                    atualizarContadores();
                }
            } catch (erro) {
                console.error('Erro ao marcar notificação:', erro);
                alert('Erro ao marcar notificação como lida');
            }
        }

        async function marcarTodasComoLidas() {
            try {
                const response = await fetch('/notificacoes/marcar-todas-lidas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    // Atualizar todas visualmente
                    document.querySelectorAll('.notificacao-item').forEach(item => {
                        item.classList.remove('nao-lida');
                        item.classList.add('lida');
                        
                        const badge = item.querySelector('.badge-nova');
                        if (badge) badge.remove();
                        
                        const btn = item.querySelector('.btn-marcar-lida');
                        if (btn) btn.remove();
                    });
                    
                    // Atualizar contadores
                    atualizarContadores();
                    
                    alert('Todas as notificações foram marcadas como lidas!');
                }
            } catch (erro) {
                console.error('Erro ao marcar todas como lidas:', erro);
                alert('Erro ao marcar notificações como lidas');
            }
        }

        function atualizarContadores() {
            // Atualizar estatísticas
            const naoLidas = document.querySelectorAll('.notificacao-item.nao-lida').length;
            const total = document.querySelectorAll('.notificacao-item').length;
            
            // Aqui você pode atualizar os contadores na página se quiser
            console.log(`Atualizado: ${naoLidas} não lidas, ${total} total`);
            
            // Recarregar a página após 1 segundo para atualizar os stats
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Adicionar efeito de clique
        document.querySelectorAll('.notificacao-item').forEach(item => {
            item.addEventListener('click', function() {
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
    </script>
</body>
</html>