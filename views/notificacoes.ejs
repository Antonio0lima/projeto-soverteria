<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificações</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/notificacoes.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <% if (usuario && usuario.tipo==="admin" ) { %>
        <%- include("partials/navbar/navbar-adm") %>
    <% } else { %>
        <%- include("partials/navbar/navbar") %>
    <% } %>

    <h1 class="titulo-pagina">
        <i class="fas fa-bell"></i> Notificações
    </h1>

    <div class="notificacoes-container">
        
        <div class="notificacoes-header">
            <button class="btn-marcar-todas" onclick="marcarTodasComoLidas()">
                <i class="fas fa-check-double"></i> Marcar todas como lidas
            </button>
            
            <a href="/inicial" class="btn-voltar">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>

        <div class="notificacoes-stats">
            <div class="stat-card">
                <div class="stat-number"><%= notificacoes.filter(n => !n.lida).length %></div>
                <div class="stat-label">Não lidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><%= notificacoes.length %></div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div class="notificacoes-list">
            <% if (notificacoes.length === 0) { %>
                <div class="notificacao-vazia">
                    <i class="fas fa-bell-slash"></i>
                    <h3>Nenhuma notificação</h3>
                    <p>Quando houver atualizações, elas aparecerão aqui.</p>
                </div>
            <% } else { %>
                <% notificacoes.forEach(n => { %>
                    <div class="notificacao-item <%= n.lida ? 'lida' : 'nao-lida' %>" 
                         onclick="marcarComoLida('<%= n.id %>', this)">
                        
                        <div class="notificacao-icon">
                            <% if (n.tipo === 'status_pedido') { %>
                                <i class="fas fa-shopping-bag"></i>
                            <% } else { %>
                                <i class="fas fa-info-circle"></i>
                            <% } %>
                        </div>

                        <div class="notificacao-content">
                            <div class="notificacao-titulo">
                                <%= n.titulo %>
                                <% if (!n.lida) { %>
                                    <span class="badge-nova">NOVA</span>
                                <% } %>
                            </div>
                            <div class="notificacao-mensagem"><%= n.mensagem %></div>
                            <div class="notificacao-data">
                                <i class="fas fa-clock"></i> <%= n.data_formatada %>
                                <% if (n.pedido_id) { %>
                                    <span class="pedido-id">Pedido #<%= n.pedido_id %></span>
                                <% } %>
                            </div>
                        </div>

                        <div class="notificacao-actions">
                            <% if (!n.lida) { %>
                                <button class="btn-marcar-lida" onclick="event.stopPropagation(); marcarComoLida('<%= n.id %>', this.parentElement.parentElement)">
                                    <i class="fas fa-check"></i>
                                </button>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <script>
        async function marcarComoLida(notificacao_id, elemento) {
            try {
                const response = await fetch('/notificacao/marcar-lida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificacao_id })
                });

                const data = await response.json();
                
                if (data.sucesso && elemento) {
                    elemento.classList.remove('nao-lida');
                    elemento.classList.add('lida');
                    
                    const badge = elemento.querySelector('.badge-nova');
                    if (badge) badge.remove();

                    const btn = elemento.querySelector('.btn-marcar-lida');
                    if (btn) btn.remove();
                    
                    atualizarContadores();
                }
            } catch (erro) {
                console.error('Erro ao marcar:', erro);
            }
        }

        async function marcarTodasComoLidas() {
            try {
                const response = await fetch('/notificacoes/marcar-todas-lidas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    document.querySelectorAll('.notificacao-item').forEach(item => {
                        item.classList.remove('nao-lida');
                        item.classList.add('lida');
                        const badge = item.querySelector('.badge-nova');
                        if (badge) badge.remove();
                        const btn = item.querySelector('.btn-marcar-lida');
                        if (btn) btn.remove();
                    });
                    atualizarContadores();
                }
            } catch (erro) {
                console.error('Erro ao marcar todas:', erro);
            }
        }

        function atualizarContadores() {
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        document.querySelectorAll('.notificacao-item').forEach(item => {
            item.addEventListener('click', function() {
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
    </script>
</body>
</html>