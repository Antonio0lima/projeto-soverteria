<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio</title>

    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/cardapio.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
</head>
<body>

    <%- include('partials/navbar/navbar') %>

    <div class="pagina-container">

        <main class="conteudo-principal">

            <section class="card painel-opcoes">
                <div class="opcoes-header">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="opcoes-body">
                    <% if (typeof categorias !== 'undefined' && categorias.length > 0) { %>
                        <% categorias.forEach((cat, index) => { %>
                            <div class="categoria-botao" data-index="<%= index %>">
                                <h2><%= cat.nome %></h2>
                                <i class="fas fa-chevron-right seta-lateral"></i>
                            </div>
                            <hr style="opacity:0.3; margin: 5px 0; border: 0;">
                        <% }) %>
                    <% } else { %>
                        <p style="padding: 20px; text-align: center; font-size: 0.8em;">Nenhuma categoria encontrada.</p>
                    <% } %>
                </div>
            </section>

            <section class="card painel-lista-produtos" id="painel-produtos">
                <div class="msg-vazia">
                    <i class="fas fa-arrow-left"></i>
                    <span>Selecione uma categoria ao lado</span>
                </div>
                <div class="grid-produtos-container"></div>
            </section>

            <section class="card painel-produto-escolhido">
                <span style="color: #555; font-size: 0.6em;">Selecione um produto acima</span>
            </section>

        </main>

        <div class="container-botao-final">
            <button class="botao-confirmacao">
                <i class="fas fa-check"></i>
            </button>
        </div>

    </div>

    <input type="hidden" id="dados-server" value="<%= JSON.stringify(typeof categorias !== 'undefined' ? categorias : []) %>">

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. CARREGAR DADOS
            let dadosDoBanco = [];
            try {
                const inputDados = document.getElementById('dados-server');
                if (inputDados && inputDados.value) {
                    dadosDoBanco = JSON.parse(inputDados.value);
                    console.log("Cardápio carregado:", dadosDoBanco.length, "categorias.");
                }
            } catch (err) {
                console.error("Erro ao ler dados:", err);
            }

            // Elementos
            const containerProdutos = document.querySelector('.grid-produtos-container');
            const painelDetalhes = document.querySelector('.painel-produto-escolhido');
            const msgVazia = document.querySelector('.msg-vazia');
            const botoesCategoria = document.querySelectorAll('.categoria-botao');

            // 2. VIGIAR CLIQUES NAS CATEGORIAS
            botoesCategoria.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Pega o índice que guardamos no HTML (data-index)
                    const index = btn.getAttribute('data-index');
                    console.log("Clicou na categoria índice:", index);

                    selecionarCategoria(index, btn);
                });
            });

            // --- FUNÇÃO PARA MOSTRAR OS PRODUTOS ---
            function selecionarCategoria(index, botaoClicado) {
                // Visual (Amarelo)
                botoesCategoria.forEach(b => b.classList.remove('ativo'));
                botaoClicado.classList.add('ativo');

                // Dados
                const categoria = dadosDoBanco[index];
                if (!categoria) return;

                const listaProdutos = categoria.produtos;

                // Limpa telas
                containerProdutos.innerHTML = '';
                painelDetalhes.innerHTML = '<span style="color: #555; font-size: 0.6em;">Selecione um produto acima</span>';

                // Verifica vazio
                if (!listaProdutos || listaProdutos.length === 0) {
                    msgVazia.style.display = 'flex';
                    msgVazia.querySelector('span').innerText = 'Categoria vazia.';
                    return;
                }
                msgVazia.style.display = 'none';

                // Renderiza Produtos
                listaProdutos.forEach(prod => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-circulo"></div>
                        <span>${prod.nome}</span>
                    `;
                    
                    // Clique no Produto
                    div.addEventListener('click', () => {
                        selecionarProduto(prod, div);
                    });

                    containerProdutos.appendChild(div);
                });
            }

            // --- FUNÇÃO PARA MOSTRAR TAMANHOS ---
            function selecionarProduto(produto, elementoHtml) {
                console.log("Produto:", produto.nome);

                document.querySelectorAll('.item').forEach(i => i.classList.remove('selecionado'));
                elementoHtml.classList.add('selecionado');

                let htmlTamanhos = '';
                if (produto.opcoes && produto.opcoes.length > 0) {
                    produto.opcoes.forEach(opcao => {
                        let preco = parseFloat(opcao.preco).toFixed(2).replace('.', ',');
                        htmlTamanhos += `
                            <button class="btn-tamanho" style="margin:5px; padding:10px; cursor:pointer; border-radius:10px; border:1px solid #ccc; background:white;">
                                <div style="font-weight:bold; color:#ff914d;">${opcao.tamanho}</div>
                                <div>R$ ${preco}</div>
                            </button>
                        `;
                    });
                } else {
                    htmlTamanhos = '<p style="padding:10px; font-size:0.8em">Indisponível.</p>';
                }

                painelDetalhes.innerHTML = `
                    <div style="text-align:center; width:100%; animation:fadeIn 0.3s;">
                        <h2 style="margin-bottom:5px;">${produto.nome}</h2>
                        <p style="font-size:0.8em; color:#666; margin-top:0;">${produto.descricao || ''}</p>
                        <hr style="opacity:0.2; margin:10px 0;">
                        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
                            ${htmlTamanhos}
                        </div>
                    </div>
                `;
            }
        });
    </script>

</body>
</html>