<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio</title>

    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/cardapio.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
</head>
<body>

    <%- include('partials/navbar/navbar') %>

    <div class="pagina-container">

        <main class="conteudo-principal">

            <section class="card painel-opcoes">
                <div class="opcoes-header">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="opcoes-body">
                    <% if (typeof categorias !== 'undefined' && categorias.length > 0) { %>
                        <% categorias.forEach((cat, index) => { %>
                            <div class="categoria-botao" data-index="<%= index %>">
                                <h2><%= cat.nome %></h2>
                                <i class="fas fa-chevron-right seta-lateral"></i>
                            </div>
                            <hr style="opacity:0.3; margin: 5px 0; border: 0;">
                        <% }) %>
                    <% } else { %>
                        <p style="padding: 20px; text-align: center; font-size: 0.8em;">Nenhuma categoria encontrada.</p>
                    <% } %>
                </div>
            </section>

            <section class="card painel-lista-produtos" id="painel-produtos">
                <div class="msg-vazia">
                    <i class="fas fa-arrow-left"></i>
                    <span>Selecione uma categoria ao lado</span>
                </div>
                <div class="grid-produtos-container"></div>
            </section>

            <section class="card painel-produto-escolhido">
                <span style="color: #555; font-size: 0.6em;">Selecione um produto acima</span>
            </section>

        </main>

        <div class="container-botao-final">
            <button class="botao-confirmacao">
                <i class="fas fa-check"></i>
            </button>
        </div>

    </div>

    <input type="hidden" id="dados-server" value="<%= JSON.stringify(typeof categorias !== 'undefined' ? categorias : []) %>">

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // Variáveis Globais
            let dadosDoBanco = [];
            let produtoEmVisualizacao = null;

            // --- 1. CARREGAR DADOS ---
            try {
                const inputDados = document.getElementById('dados-server');
                if (inputDados && inputDados.value) {
                    dadosDoBanco = JSON.parse(inputDados.value);
                    console.log("Cardápio carregado.");
                }
            } catch (err) {
                console.error("Erro ao ler dados:", err);
            }

            // Elementos DOM
            const containerProdutos = document.querySelector('.grid-produtos-container');
            const painelDetalhes = document.querySelector('.painel-produto-escolhido');
            const msgVazia = document.querySelector('.msg-vazia');
            const botoesCategoria = document.querySelectorAll('.categoria-botao');
            const painelProdutosSection = document.getElementById('painel-produtos');
            const btnConfirmar = document.querySelector('.botao-confirmacao');

            // --- 2. VIGIAR CLIQUES NAS CATEGORIAS ---
            botoesCategoria.forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.getAttribute('data-index');
                    selecionarCategoria(index, btn);
                });
            });

            // --- 3. EVENTO DO BOTÃO CONFIRMAR ---
            if(btnConfirmar) {
                btnConfirmar.addEventListener('click', adicionarAoCarrinho);
            }

            // --- FUNÇÃO: SELECIONAR CATEGORIA ---
            function selecionarCategoria(index, botaoClicado) {
                botoesCategoria.forEach(b => b.classList.remove('ativo'));
                botaoClicado.classList.add('ativo');
                
                produtoEmVisualizacao = null; 

                const categoria = dadosDoBanco[index];
                if (!categoria) return;

                const listaProdutos = categoria.produtos;

                containerProdutos.innerHTML = '';
                painelDetalhes.innerHTML = '<span style="color: #555; font-size: 0.6em;">Selecione um produto acima</span>';

                if (!listaProdutos || listaProdutos.length === 0) {
                    msgVazia.style.display = 'flex';
                    msgVazia.querySelector('span').innerText = 'Categoria vazia.';
                    return;
                }
                msgVazia.style.display = 'none';

                listaProdutos.forEach(prod => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-circulo"></div>
                        <span>${prod.nome}</span>
                    `;
                    
                    div.addEventListener('click', () => {
                        selecionarProduto(prod, div);
                    });

                    containerProdutos.appendChild(div);
                });

                if (window.innerWidth < 900) {
                    painelProdutosSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // --- FUNÇÃO: SELECIONAR PRODUTO (ATUALIZADA) ---
            function selecionarProduto(produto, elementoHtml) {
                console.log("Visualizando:", produto.nome);
                produtoEmVisualizacao = produto;

                const botaoAtivo = document.querySelector('.categoria-botao.ativo');
                let listaAdicionais = [];
                if (botaoAtivo) {
                    const indexCat = botaoAtivo.getAttribute('data-index');
                    if (dadosDoBanco[indexCat] && dadosDoBanco[indexCat].adicionais) {
                        listaAdicionais = dadosDoBanco[indexCat].adicionais;
                    }
                }

                document.querySelectorAll('.item').forEach(i => i.classList.remove('selecionado'));
                elementoHtml.classList.add('selecionado');

                // --- GERAÇÃO DOS BOTÕES DE TAMANHO ---
                let htmlTamanhos = '';
                if (produto.opcoes && produto.opcoes.length > 0) {
                    
                    // LÓGICA DE AUTO-SELEÇÃO:
                    // Se tiver só 1 opção, adiciona a classe 'tamanho-ativo' automaticamente
                    const classeAutoSelect = produto.opcoes.length === 1 ? 'tamanho-ativo' : '';

                    produto.opcoes.forEach(opcao => {
                        let preco = parseFloat(opcao.preco).toFixed(2).replace('.', ',');
                        
                        // Adicionamos ${classeAutoSelect} na class do botão
                        htmlTamanhos += `
                            <button class="btn-tamanho ${classeAutoSelect}" 
                                onclick="toggleTamanho(this)"
                                data-tamanho="${opcao.tamanho}"
                                data-preco="${opcao.preco}">
                                <div class="nome-tamanho">${opcao.tamanho}</div>
                                <div class="preco-tamanho">R$ ${preco}</div>
                            </button>
                        `;
                    });
                } else {
                    htmlTamanhos = '<p style="padding:10px; font-size:0.8em">Indisponível.</p>';
                }

                // --- GERAÇÃO DOS ADICIONAIS ---
                let htmlAdicionais = '';
                if (listaAdicionais.length > 0) {
                    htmlAdicionais += `<h3 style="margin: 20px 0 10px 0; font-size: 1.4em; color:#ff914d;">Turbine seu pedido:</h3>`;
                    htmlAdicionais += `<div class="lista-adicionais">`;
                    
                    listaAdicionais.forEach(add => {
                        let textoPreco = parseFloat(add.preco) > 0 
                            ? `+ R$ ${parseFloat(add.preco).toFixed(2).replace('.', ',')}` 
                            : 'Grátis';

                        htmlAdicionais += `
                            <label class="item-adicional">
                                <input type="checkbox" name="adicional" 
                                    value="${add.id}" 
                                    data-nome="${add.nome}" 
                                    data-preco="${add.preco}">
                                <span>${add.nome} <small>(${textoPreco})</small></span>
                            </label>
                        `;
                    });
                    htmlAdicionais += `</div>`;
                }

                painelDetalhes.innerHTML = `
                    <div class="detalhes-container">
                        <h2 style="margin-bottom:5px;">${produto.nome}</h2>
                        <p style="font-size:0.8em; color:#666; margin-top:0;">${produto.descricao || ''}</p>
                        <hr style="opacity:0.2; margin:10px 0;">
                        
                        <div style="font-weight:bold; margin-bottom:5px; color:#555;">Escolha o tamanho:</div>
                        <div class="flex-tamanhos">${htmlTamanhos}</div>
                        ${htmlAdicionais}
                    </div>
                `;

                if (window.innerWidth < 900) {
                    painelDetalhes.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // --- FUNÇÃO: MARCAR TAMANHO ---
            window.toggleTamanho = function(btn) {
                document.querySelectorAll('.btn-tamanho').forEach(b => {
                    b.classList.remove('tamanho-ativo');
                });
                btn.classList.add('tamanho-ativo');
            }

            // --- FUNÇÃO PRINCIPAL: ADICIONAR AO CARRINHO ---
            function adicionarAoCarrinho() {
                if (!produtoEmVisualizacao) {
                    alert("Por favor, selecione um produto primeiro.");
                    return;
                }

                const btnTamanhoAtivo = document.querySelector('.btn-tamanho.tamanho-ativo');
                if (!btnTamanhoAtivo) {
                    alert("Você precisa escolher um tamanho!");
                    const areaTamanhos = document.querySelector('.flex-tamanhos');
                    if(areaTamanhos) areaTamanhos.style.border = "2px dashed red";
                    setTimeout(() => { if(areaTamanhos) areaTamanhos.style.border = "none"; }, 2000);
                    return;
                }

                const btnConfirmar = document.querySelector('.botao-confirmacao');
                btnConfirmar.classList.add('animar');

                setTimeout(() => {
                    const tamanhoNome = btnTamanhoAtivo.getAttribute('data-tamanho');
                    const tamanhoPreco = parseFloat(btnTamanhoAtivo.getAttribute('data-preco'));

                    const checkboxes = document.querySelectorAll('input[name="adicional"]:checked');
                    let listaAdicionaisEscolhidos = [];
                    let totalAdicionais = 0;

                    checkboxes.forEach(chk => {
                        const addNome = chk.getAttribute('data-nome');
                        const addPreco = parseFloat(chk.getAttribute('data-preco'));
                        
                        listaAdicionaisEscolhidos.push({
                            id: chk.value,
                            nome: addNome,
                            preco: addPreco
                        });
                        totalAdicionais += addPreco;
                    });

                    const precoTotal = tamanhoPreco + totalAdicionais;

                    const novoItem = {
                        id_unico: Date.now(),
                        produto_id: produtoEmVisualizacao.id,
                        produto_nome: produtoEmVisualizacao.nome,
                        tamanho: tamanhoNome,
                        preco_base: tamanhoPreco,
                        adicionais: listaAdicionaisEscolhidos,
                        preco_total: precoTotal,
                        quantidade: 1
                    };

                    console.log("Adicionando ao carrinho:", novoItem);

                    let carrinho = JSON.parse(localStorage.getItem('carrinho_sorveteria') || '[]');
                    carrinho.push(novoItem);
                    localStorage.setItem('carrinho_sorveteria', JSON.stringify(carrinho));

                    alert("✅ Produto adicionado ao carrinho!");

                    document.querySelectorAll('.btn-tamanho').forEach(b => b.classList.remove('tamanho-ativo'));
                    document.querySelectorAll('input[name="adicional"]').forEach(chk => chk.checked = false);
                    
                    btnConfirmar.classList.remove('animar');

                }, 150);
            }
        });
    </script>

</body>
</html>