<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido</title>
    
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/finalizacao.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
</head>
<body>

    <% if (typeof usuario !== 'undefined' && usuario && usuario.tipo === "admin") { %>
        <%- include("partials/navbar/navbar-adm") %>
    <% } else { %>
        <%- include("partials/navbar/navbar") %>
    <% } %>

    <div class="pagina-container">
   
        <h1 class="titulo-pagina"><i class="fas fa-check-circle"></i> Finalização</h1>

        <div class="grid-finalizacao">
            
            <div class="card-pagamento">
                <h2>Pagamento via PIX</h2>
                
                <div class="qrcode-area">
                     <i class="fas fa-qrcode qrcode-placeholder"></i>
                    <p>QRCode indisponível no momento</p>
                </div>

                <p style="text-align:center; font-size:0.9em; margin-bottom:15px;">
                    Escaneie o código acima ou pague no balcão.
                </p>

                <div class="input-file-container">
                    <label for="comprovante-upload" class="input-file-trigger">
                        <i class="fas fa-file-upload"></i>
                        <span>Anexar Comprovante</span>
                    </label>
                    <input type="file" id="comprovante-upload" class="input-file-hidden" accept="image/*, .pdf">
                    <div class="nome-arquivo"></div>
                </div>
            </div>

            <div class="card-resumo">
                <h2>Resumo do Pedido</h2>
                
                <div class="lista-resumo">
                    <p>Carregando itens...</p>
                </div>

                <div class="total-final">
                    Total: <span>R$ 0,00</span>
                </div>

                <button class="btn-concluir">
                    CONCLUIR PEDIDO <i class="fas fa-arrow-right"></i>
                </button>
                
                <p class="aviso-pagamento">
                    * O pagamento pode ser feito no ato da entrega/retirada.
                </p>
            </div>

        </div>
    </div>

    <input type="hidden" id="id-cliente-final" value="<%= (typeof usuario !== 'undefined' && usuario) ? usuario.id : '' %>">

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. ELEMENTOS
            const listaResumo = document.querySelector('.lista-resumo');
            const totalEl = document.querySelector('.total-final span');
            const btnConcluir = document.querySelector('.btn-concluir');
            const idClienteInput = document.getElementById('id-cliente-final');
            const fileInput = document.getElementById('comprovante-upload');
            const nomeArquivoDiv = document.querySelector('.nome-arquivo');
            
            // 2. CARREGAR CARRINHO
            let carrinho = JSON.parse(localStorage.getItem('carrinho_sorveteria') || '[]');

            if (carrinho.length === 0) {
                window.location.href = "/cardapio";
                return;
            }

            // 3. UI: MOSTRAR NOME DO ARQUIVO SELECIONADO
            if(fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        nomeArquivoDiv.textContent = "Arquivo: " + this.files[0].name;
                        nomeArquivoDiv.style.color = "#333";
                        nomeArquivoDiv.style.fontWeight = "bold";
                    } else {
                        nomeArquivoDiv.textContent = "";
                    }
                });
            }

            // 4. DESENHAR HTML
            listaResumo.innerHTML = "";
            let total = 0;

            carrinho.forEach(item => {
                total += item.preco_total;
                let textoAdd = "";
                if(item.adicionais && item.adicionais.length > 0) {
                    const nomes = item.adicionais.map(a => a.nome).join(', ');
                    textoAdd = `<div style="font-size:0.8em; color:#d35400; margin-left:10px;">+ ${nomes}</div>`;
                }

                const div = document.createElement('div');
                div.style.marginBottom = "10px";
                div.style.borderBottom = "1px solid rgba(0,0,0,0.1)";
                div.style.paddingBottom = "5px";
                div.style.display = "flex";
                div.style.justifyContent = "space-between";
                div.innerHTML = `
                    <div>
                        <strong>${item.quantidade}x ${item.produto_nome}</strong> <small>(${item.tamanho})</small>
                        ${textoAdd}
                    </div>
                    <div>R$ ${item.preco_total.toFixed(2).replace('.', ',')}</div>
                `;
                listaResumo.appendChild(div);
            });

            totalEl.innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;

            // 5. AÇÃO DO BOTÃO (Com FormData)
            btnConcluir.addEventListener('click', async () => {
                const idCliente = idClienteInput.value;
                
                if (!idCliente) {
                    alert("Você precisa estar logado para concluir!");
                    window.location.href = "/"; 
                    return;
                }

                btnConcluir.innerText = "Enviando...";
                btnConcluir.disabled = true;

                const formData = new FormData();
                formData.append('id_cliente', idCliente);
                formData.append('valor', total.toFixed(2));
                formData.append('produtos', JSON.stringify(carrinho));

                if (fileInput && fileInput.files.length > 0) {
                    formData.append('comprovante', fileInput.files[0]);
                }

                try {
                    const resp = await fetch('/finalizar-pedido', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const resultado = await resp.json();

                    if (resultado.sucesso) {
                        localStorage.removeItem('carrinho_sorveteria');
                        window.location.href = "/pedido-concluido";
                    } else {
                        alert("Erro ao salvar: " + (resultado.erro || "Desconhecido"));
                        btnConcluir.innerText = "CONCLUIR PEDIDO";
                        btnConcluir.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    alert("Erro de conexão com o servidor.");
                    btnConcluir.innerText = "CONCLUIR PEDIDO";
                    btnConcluir.disabled = false;
                }
            });
        });
    </script>
</body>
</html>