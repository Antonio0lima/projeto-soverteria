<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Produtos</title>
  
  <link rel="stylesheet" href="/css/lista-produtos.css">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body> 
  <% if (usuario && usuario.tipo==="admin") { %>
    <%- include("partials/navbar/navbar-adm") %>
  <% } else { %>
    <%- include("partials/navbar/navbar") %>
  <% } %>

  <h1 class="titulo-pagina">
    <i class="fa-solid fa-ice-cream"></i> Gerenciar Cardápio
  </h1>

  <div class="lista-produtos-container">
    
    <div class="area-novo-produto">
      <button class="btn-novo-produto" onclick="abrirPopupNovoProduto()">
        <i class="fa-solid fa-plus-circle"></i> Novo Produto
      </button>
    </div>

    <div class="conteudo-lista">
      <% categorias.forEach(categoria => { %>
        <% if (categoria.produtos.length > 0) { %>
          <div class="categoria-section">
            <h2 class="titulo-categoria"><%= categoria.nome %></h2>
            
            <% categoria.produtos.forEach(produto => { %>
              <div class="linha-produto">
                <div class="info-produto">
                  <span class="nome-produto"><%= produto.nome %></span>
                  
                  <% if (produto.descricao) { %>
                    <span class="descricao-produto"><%= produto.descricao %></span>
                  <% } %>
                  
                  <div class="tamanhos-wrapper">
                    <% produto.tamanhos.forEach(tamanho => { %>
                      <span class="tag-tamanho">
                        <%= tamanho.nome %>: R$ <%= parseFloat(tamanho.preco).toFixed(2) %>
                      </span>
                    <% }) %>
                  </div>
                </div>

                <div class="botoes-acao">
                  <div class="botao-editar" onclick="editarProduto('<%= produto.id %>')" title="Editar">
                    <i class="fa-solid fa-pencil"></i>
                  </div>
                  <div class="botao-excluir" onclick="excluirProduto('<%= produto.id %>')" title="Excluir">
                    <i class="fa-solid fa-trash"></i>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      <% }) %>

      <% if (adicionais.length > 0) { %>
        <div class="categoria-section">
          <h2 class="titulo-categoria">Adicionais</h2>
          
          <% adicionais.forEach(adicional => { %>
            <div class="linha-produto">
              <div class="info-produto">
                <span class="nome-produto"><%= adicional.nome %></span>
                <span class="descricao-produto"><%= adicional.descricao || 'Adicional' %></span>
                
                <div class="tamanhos-wrapper">
                  <span class="tag-tamanho">
                    R$ <%= parseFloat(adicional.preco).toFixed(2) %>
                  </span>
                  <% if (adicional.categoria_nome) { %>
                    <span class="tag-categoria"><%= adicional.categoria_nome %></span>
                  <% } %>
                </div>
              </div>

              <div class="botoes-acao">
                <div class="botao-editar" onclick="editarAdicional('<%= adicional.id %>')">
                  <i class="fa-solid fa-pencil"></i>
                </div>
                <div class="botao-excluir" onclick="excluirAdicional('<%= adicional.id %>')">
                  <i class="fa-solid fa-trash"></i>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>

  <div id="popupProduto" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2 id="popupTitulo">Novo Produto</h2>
        <span class="close-popup" onclick="fecharPopup()">&times;</span>
      </div>
      
      <form id="formProduto">
        <input type="hidden" id="produtoId">
        
        <div class="form-group">
          <label>Nome do Produto:</label>
          <input type="text" id="produtoNome" required>
        </div>
        
        <div class="form-group">
          <label>Descrição:</label>
          <textarea id="produtoDescricao" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Categoria:</label>
          <select id="produtoCategoria" required>
            <option value="">Selecione uma categoria</option>
            <% categorias.forEach(categoria => { %>
              <option value="<%= categoria.id %>"><%= categoria.nome %></option>
            <% }) %>
          </select>
        </div>
        
        <div class="form-group">
          <label>Tamanhos e Preços:</label>
          <div id="tamanhosContainer"></div>
          <button type="button" class="btn-adicionar" onclick="adicionarTamanho()">
            <i class="fa-solid fa-plus"></i> Adicionar Tamanho
          </button>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn-salvar">Salvar</button>
          <button type="button" class="btn-cancelar" onclick="fecharPopup()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function abrirPopupNovoProduto() {
      document.getElementById('popupTitulo').textContent = 'Novo Produto';
      document.getElementById('formProduto').reset();
      document.getElementById('produtoId').value = '';
      document.getElementById('tamanhosContainer').innerHTML = '';
      document.getElementById('popupProduto').style.display = 'flex';
    }

    function editarProduto(id) {
      document.getElementById('popupTitulo').textContent = 'Editar Produto';
      document.getElementById('produtoId').value = id;
      document.getElementById('popupProduto').style.display = 'flex';
      // Lógica de fetch dos dados viria aqui
    }

    function excluirProduto(id) {
      if (confirm('Deseja excluir este produto?')) {
        console.log('Excluir:', id);
      }
    }

    function editarAdicional(id) { console.log('Edit Add:', id); }
    function excluirAdicional(id) { 
      if(confirm('Excluir adicional?')) console.log('Del Add:', id); 
    }

    function fecharPopup() {
      document.getElementById('popupProduto').style.display = 'none';
    }

    function adicionarTamanho() {
      const container = document.getElementById('tamanhosContainer');
      const div = document.createElement('div');
      div.className = 'tamanho-item';
      div.innerHTML = `
        <input type="text" placeholder="Tamanho (ex: 300ml)" required>
        <input type="number" placeholder="Preço" step="0.01" min="0" required>
        <button type="button" class="btn-remover-tamanho" onclick="this.parentElement.remove()">
          <i class="fa-solid fa-times"></i>
        </button>
      `;
      container.appendChild(div);
    }

    document.getElementById('popupProduto').addEventListener('click', function(e) {
      if (e.target === this) fecharPopup();
    });

    document.getElementById('formProduto').addEventListener('submit', function(e) {
      e.preventDefault();
      // Lógica de salvar
      fecharPopup();
    });
  </script>
</body>
</html>